function normalizeCollection(i,t){return t=t||[],_.map(i,function(i){return _.assign({},_.zipObject(t,_.fill(Array(t.length),null)),i)})}var intro=function(){function i(){$splash.vide({mp4:"http://cf.pasoliniroma.com/static/ruiz/video/intro-1.mp4"},{loop:!0,muted:!0,position:"50% 0%"}),o=$splash.data("vide"),$intro.perfectScrollbar({suppressScrollX:!0}),$(".enter").on("click",function(){$.publish("intro.enter")})}function t(){a!==!0&&(o.getVideoObject().play(),$intro.fadeIn(500),$intro.scrollTop(0),a=!0)}function n(){a!==!1&&($intro.fadeOut(500),o.getVideoObject().pause(),a=!1)}function e(i,t){$.subscribe(i,t)}var o,a=!1;return{init:i,open:t,close:n,on:e}}(),map=function(){function i(){a=arguments[0],r=arguments[1],t()}function t(){f.append("path").datum(topojson.feature(a,a.objects.land)).attr("class","land").attr("d",l),f.selectAll(".pin").data(r).enter().append("circle").attr("class","pin").attr("data-id",function(i){return i.id}).attr("r",function(i){return 6+3*i.cards.length}).attr("transform",function(i){return"translate("+u([i.coordinates[0],i.coordinates[1]])+")"}).each(function(i){_.assign(i,{svg:this})}).on("click",function(i){$.publish("map.click",i)}),f.call(p).call(p.event),p.on("zoom.redraw",o),$.publish("map.ready")}function n(i,t){$.subscribe(i,t)}function e(i){u.rotate(p.rotateTo(i.coordinates)),f.transition().duration(1e3).call(p.projection(u).event),m=i}function o(){f.selectAll(".land").attr("d",l),f.selectAll(".pin").attr("transform",function(i){return"translate("+u([i.coordinates[0],i.coordinates[1]])+")"})}var a,r,s=window.innerHeight,c=window.innerWidth/2,d=[.333*Math.max(c,s),[2.5*Math.max(c,s)]],u=d3.geo.august().center([0,0]).rotate([60,0,-180]).scale(d[0]).translate([c/2,s/2]),l=d3.geo.path().projection(u),p=d3.geo.zoom().projection(u).scale(d[0]).scaleExtent(d),f=d3.select("svg"),m={};return{init:i,on:n,panTo:e}}(),card=function(){function i(){a=arguments[0],$(r).perfectScrollbar({suppressScrollX:!0,wheelSpeed:3})}function t(i){_.forEach(_.reverse(i.cards),function(t,n){t.text=t.text||"Quam quidem partem accusationis admiratus sum et moleste tuli potissimum esse Atratino datam. Neque enim decebat neque aetas illa postulabat neque, id quod animadvertere poteratis, pudor patiebatur optimi adulescentis in tali illum oratione versari. Vellem aliquis ex vobis robustioribus hunc male dicendi locum suscepisset; aliquanto liberius et fortius et magis more nostro refutaremus istam male dicendi licentiam. Tecum, Atratine, agam lenius, quod et pudor tuus moderatur orationi meae et meum erga te parentemque tuum beneficium tueri debeo.",c.push($(s.card(_.assign({},t,{pointId:i.id,cardTitle:o(i.name,t.title,i.cards.length-n)}))))}),function t(i){if(0===i.length)return $(r).scrollTop(0).perfectScrollbar("update"),void $.publish("load");var n=i[0];_.isUndefined(n.isRemove)===!1?(i.shift(),n.animate({opacity:0},250,"easeOutQuad",function(){n.remove(),t(i)})):(_.assign(n,{isRemove:!0}),n.imagesLoaded(function(){n.css({visibility:"none",opacity:0}).prependTo($(r));var e=n.height();n.css({height:0,visibility:"visible"}).animate({height:e+"px",opacity:1},450,"easeOutQuad",function(){window.setTimeout(function(){t(_.tail(i))},100)})}))}(c)}function n(){c=[],$(r).empty()}function e(i,t){$.subscribe(i,t)}function o(i,t,n){var e="";return i=i||"",t=t||"",""!=i&&(e+=i),""!=i&&""!=t&&(e+="&nbsp;: "),""!=t&&(e+=t),e}var a,r=document.querySelector(".cardContainer"),s={},c=[];return _.templateSettings.interpolate=/{{([\s\S]+?)}}/g,s.card=_.template("<div class='card' data-id='{{ id }}'><div class='mediaContainer'><% _.forEach(assets, function (asset) { %><div class='asset'><% if (asset.type === 'img') { %><img data-desc='{{ asset.desc }}' title='{{ asset.desc.replace(/<[^>]+>/g, '') }}' src='http://cf.pasoliniroma.com/static/ruiz/img/{{ asset.id }}.jpg'><% } else if (asset.type === 'video') { %><iframe class='video' src='//player.vimeo.com/video/{{ asset.id }}' frameborder='0'></iframe><% } %></div><% }); %></div><h2>{{ cardTitle }}</h2><p>{{ text }}<% var places = _.filter(points, function (p) { return p.id !== pointId; }); if (places.length > 0) { %> <span class='places'>(Voir aussi&nbsp;: <% _.forEach(places, function (p, i) { %><a href='#!/{{ p.id }}'>{{ p.name }}</a><% if (i + 1 < places.length) { %>, <% }}); %>)</span><% } %></p></div>"),{init:i,on:e,show:t,empty:n}}(),viewer=function(){function i(){r=arguments[0],r.append("<div class='viewerContent'></div><div class='viewerClose'></div>"),s=r.children(".viewerContent"),c=r.children(".viewerClose")}function t(i,t){s.append("<img src='"+i+"'><div class='caption'>"+t+"</div>"),d=s.children("img"),u=!0,n(),r.fadeIn(250,function(){c.one("click",e),$(document).on("keydown",function(i){27===i.which&&($(document).off("keydown"),c.addClass("on"))}),$(document).on("keyup",function(i){27===i.which&&(c.removeClass("on"),$(document).off("keyup"),e())})})}function n(){if(u!==!1){var i=$(window).width()-24,t=$(window).height()-80,n=a(d[0].naturalWidth,d[0].naturalHeight,i,t,!0);d.css({width:n.width+"px",height:n.height+"px",position:"absolute",top:"12px",left:(i-n.width)/2+"px"})}}function e(){r.fadeOut(250,function(){s.empty(),u=!1,$(this).hide()})}function o(){return u}function a(i,t,n,e,o){var a=i/t,r=i,s=t;return(i>n||e>t)&&(i=n,t=Math.floor(i/a)),(t>e||n>i)&&(t=e,i=Math.floor(t*a)),!!o==!1&&(i>=r||t>=s)&&(i=r,t=s),{width:i,height:t}}var r,s,c,d,u=!1;return{init:i,open:t,isOpen:o}}(),$intro=$(".intro"),$splash=$intro.find(".splash"),$title=$splash.find(".title");intro.init(),d3_queue.queue().defer(d3.json,"data/world-110m.json").defer(d3.json,"data/cards.json").defer(d3.json,"data/points.json").awaitAll(function(i,t){function n(){var i=a(this.params.pid,this.params.cid),t=i.pid,n=i.cid,r=_.find(c,{id:t});return $(".content").show(),intro.close(),i.isModified?void o(t,n):r?($(_.map(c,"svg")).removeClass("on"),$(r.svg).addClass("on"),map.panTo(r),void card.show(r)):void o(e())}function e(){return _.sample(c).id}function o(i,t){i=parseInt(i,10)||null,t=parseInt(t,10)||null,i?t?window.location.hash="#!/"+i+"/"+t:window.location.hash="#!/"+i:window.location.hash="#!/"+e()}function a(i,t){i=parseInt(i,10)||null,t=parseInt(t,10)||null;var n,e={pid:null,cid:null},o=_.find(s,{id:t});return _.isUndefined(o)?(n=_.find(c,{id:i}),_.isUndefined(n)||(e.pid=n.id,o=_.find(n.cards,{id:t}),_.isUndefined(o)||(e.cid=o.id))):(n=_.find(o.points,{id:i}),e.cid=t,e.pid=_.isUndefined(n)?o.points[0].id:n.id),e.isModified=i!==e.pid||t!==e.cid,e}if(i)throw i;var r,s,c;r=t[0],s=_(t[1]).thru(function(i){return normalizeCollection(i,["assets","text","copyright"])}).map(function(i){return _.assign(i,{points:[]})}).value(),c=_(t[2]).filter(function(i){return i.cards.length>0}).map(function(i){return _.assign(i,{type:"Point",coordinates:[i.lng,i.lat],cards:_.map(i.cards,function(t){var n=_.find(s,{id:t});return n.points.push(i),n})})}).value(),map.init(r,c),card.init(c),viewer.init($(".viewer")),$(".anchor").on("click",function(){window.location.hash="#!/"}),$(".cardContainer").on("click","img",function(){viewer.open(this.src,$(this).data("desc"))}),$(window).on("resize",function(){window.setTimeout(function(){window.location.reload()},10)}),intro.on("intro.enter",function(){o(e())}),map.on("map.click",function(i,t){o(t.id)}),Path.root("#!/"),Path.map("#!/").to(function(){intro.open(),card.empty()}),Path.map("#!/(:pid)(/:cid)").to(n),Path.rescue(_.noop),Path.listen()});